---
title: "連載：tidyverse"
author: "Momoko Ichinokawa"
date: "`r Sys.Date()`"
output:
  md_document
---

```{r, echo=FALSE}
library(knitr)
library(rmarkdown)
library(tidyverse)
#render("text.Rmd")

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
#                     cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
#opts_knit$set(width=75)
par(mar=c(4,4,3,1))
```
# １回目：趣旨
tidyverseって知ってますか？Rから呼び出せる一連の「便利パッケージ」を集めたメタパッケージのことです。非常に便利なので、VPA計算や将来予測ツールを提供しているfrasyrも、今後、tidyverseをどんどん取り入れていく方針に転換しています。普通にRを使って自分のデータ解析をしている人だけでなく、frasyrパッケージを使って資源計算されている人も、ぜひtidyverseの世界を知ってほしいと思っています。

それによって
- 整理されたデータ（整然データ、今後解説）を使った一連のデータ処理プロセスの固定化・単純化→研究の効率アップ
- tidyverseの標準グラフィックスシステムであるggplot2を使った効率的なグラフ作成→研究の効率アップ
- frasyr, frasyr_toolのバグ発見や修正依頼、さらには拡張コードを書くことへの障壁が少なく→皆でfrasyrを共同開発
のような効果が期待できます。

本スレッドではできるだけ1日１トピック、tidyverseで使うパッケージや関数の使い方、従来のR（裸のRと呼ぶことも）との違いなんかを、まず代表者が書き込みます。その後、何か思うところあったら、または追加の情報などをコメントとして返信してもらうことで、勉強会を進めていければと思います。スレッドは残るので、あまりリアルタイムにこだわらず、勉強したときに自由にコメントつけていっていただければと思います。

今後想定するトピックとしては
- tidy data（整然データ）とは何か？
- パイプ %>%の使い方
- ggplot2
- データ成型用パッケージ dplyr を使ったデータの整理
- などなど
です。私も細かいことあまり知らないので、より分かっている人にさらに解説してもらったりできればうれしいです。

初回は参考URLを示すことで終わりにします。来週からぽつぽつアップしますので、よろしくお願いします。

- 本家のサイト　https://r4ds.had.co.nz/　英語だけど本一冊分が無料で読めます。これを１冊通して読めばtidyverseマスター！
- 上のサイトの日本語訳　https://www.amazon.co.jp/R%E3%81%A7%E3%81%AF%E3%81%98%E3%82%81%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF%E3%82%B5%E3%82%A4%E3%82%A8%E3%83%B3%E3%82%B9-Hadley-Wickham/dp/487311814X
- tidyverseの概説とさらなる参考情報　https://heavywatal.github.io/rstats/programming.html

# 2回目：インストールと使い方

tidyverseの世界に入るときに一番最初にやること、、それは、tidyverseパッケージのインストールです。パッケージのインストール方法はいろいろありますが、コピペで済むのでここでは以下のコマンドでインストールすることにします。コマンドを打つと、「どこのサーバーからパッケージをダウンロードするか？」を聞かれることがあるので、そこはJapan(Tokyo)を選んで（多分どこを選んでもよい）、インストールします。複数のパッケージを同時にインストールするので時間がかかります。

```{r, echo=TRUE}
install.packages("tidyverse")
```

無事インストールが終わったら、以下のコマンドを打ってパッケージを呼び出してみましょう。
```{r, echo=TRUE}
library(tidyverse)
```
すると、あまり見慣れない \-\- Attaching packages \-\- とかいう表記が出てきます。

\-\- Attaching packagesの下は、tidyverseをlibraryしたことで呼び出されるパッケージの一覧（tidyverseは複数のパッケージを寄せ集めたメタパッケージなので）とそれぞれのパッケージのバージョン番号を示しています。

\-\- Conflictの下には、tidyverseパッケージを呼び出すことで生じた関数名のコンフリクト（異なるパッケージ間で同じ関数名が使われている）の一覧が示されています。 x dplyr::filter() masks stats::filter() は、「パッケージdplyrとstatの両方でfilterという関数が定義されているけど、ここでは単にfilterを呼ぶ場合はdplyrのfilterを使いますよ」という意味です。

また、ここで出てくる「::」は、用いる関数名がなんのパッケージ由来のものかを明示的に示すための記号です（つまり　**パッケージ名::関数名** ）。この方法で関数を指定すれば、library(パッケージ名)という形であらかじめパッケージを呼び出しておかなくても、自分の環境内にインストールされたパッケージの中の関数を利用することができます。逆に、**パッケージ名::** なんてつけるのめんどくさいという人は、あらかじめ自分が使う関数をlibraryで呼び出しておけばいいわけです。ただし、上記のように、複数のパッケージ間で同じ関数名を使う場合はコンフリクトがおこるので（どういう状況でどちらのパッケージが優先されるかは？なんですが）、関数が意図下通りに動かずにエラーやバグが生じる恐れがあります。特に、dplyrのfilterは非常によく使い関数なんですが、statsパッケージのfilterと同名の関数になっているため、ライブラリの呼び出しの順番によってfilterがstatsのfilterになったりdplyrのfilterになったりします。ので、filterだけにはdplyr::filterとして使ったほうが良いかと思います。

```{r, echo=TRUE}
## ::の例 (まだtidyverseをlibraryしていない状況下でお試しください）

# パッケージtibble内にある関数tibbleを使う
# ::をつければlibraryする必要はない
data_test <- tibble::tibble(a=1:5, b=2:6)

# パッケージ内の関数を呼び出してから使う場合
# libraryしてあるので::は必要ない
library(tibble)  # or library(tidyverse)
data_test <- tibble(ax=1:5, bx=2:6)
```

（**注** frasyrやfrasyr_toolでは、tidyverse内の関数をすべて「パッケージ名::関数名」としてはいません（かわりに、Rコードの最初でlibrary(tidyverse)をする必要があります）。ただし、dplyr::filterなど、コンフリクトが起こりそうな関数については::をつけています。また、gridExtraやforeachなど、２，３個しか使わないようなパッケージについては::をつけて呼び出しています。）

最後、ちょっとマニアックな話になりましたが、たまに目にする::の意味を知らないと、Rのコードを読んでいて::に遭遇したときの不安感が非常に大きいと思いますので、少し説明してみました。

次回は、tidyverseの中のパッケージがそれぞれ何をしているかの概要をお話しします。
